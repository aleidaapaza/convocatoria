{% extends 'base/base.html' %}
{% load static %}
{% block contenido %}
    <h3 class="text-center bg-success rounded-3 text-white"> {{ titulo }} </h3>
        {% if entity_registro %}
            <div class="col-md-3 mt-2">
                <a href="{{ entity_registro }}" class="btn btn-success btn-block">{{ entity_registro_nom }}</a>
            </div>
        {% endif %}
        {% if error_messages %}
            <div class="alert alert-danger">
                <ul>
                    {% for message in error_messages %}
                        <li>{{ message }}</li>
                    {% endfor %}
                </ul>
            </div>
        {% endif %}
        {% include "include/mensaje_confirmacion.html" %}
    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        {% if proyecto.tipo_financiamiento == 1 %}
            <h5 class="text-center bg-success rounded-3 text-white"> Elaboración Estudio de Diseño Técnico de Preinversión - EDTP </h5>
            <div id="mensajeelabSolicBs" style="color: red;"></div>
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>FONABOSQUE (Bs.)</th>
                            <th>SOLICITANTE (Bs.)</th>
                            <th>TOTAL (Bs.)</th>
                            <th>%FONABOSQUE %</th>
                            <th>%SOLICITANTE %</th>
                            <th>% TOTAL</th>
                        </tr>
                    </thead>
                    <tbody id="product-rows">
                        <tr>
                            <td id="elabFonaBs">0</td>
                            <input type="hidden" id="elabFonaBsHidden" name="elabFonaBs" value="0">
                            <td><input type="number" id="elabSolicBs" name="elabSolicBs" value="0.00" step="0.01" class="form-control form-control-sm font-weight-bold border border-info"></td>
                            <td id="elabTotalBs" name="elabTotalBs">0</td>
                            <input type="hidden" id="elabTotalBsHidden" name="elabTotalBs" value="0">
                            <td id="elabFonaPor" name="elabFonaPor">0%</td>
                            <input type="hidden" id="elabFonaPorHidden" name="elabFonaPor" value="0">
                            <td id="elabSolicPor" name="elabSolicPor">0%</td>
                            <input type="hidden" id="elabSolicPorHidden" name="elabSolicPor" value="0">
                            <td id="elabTotalPor" name="elabTotalPor">0%</td>
                            <input type="hidden" id="elabTotalPorHidden" name="elabTotalPor" value="0">     
                        </tr>
                    </tbody>
                </table>
            </div>
            <h5 class="text-center bg-success rounded-3 text-white"> 
            Presupuesto referencial para la Ejecucion del Estudio de Diseño Técnico de Preinversión - EDTP </h5>
        {% else %}
            <h5 class="text-center bg-success rounded-3 text-white"> 
            Ejecución Estudio de Diseño Técnico de Preinversión - EDTP </h5>
        {% endif %}
        <div id="mensajeejecFonaBs" style="color: red;"></div>
        <div id="mensajeejecFPor" style="color: red;"></div>    
        <div id="mensajeejecSPor" style="color: red;"></div>    
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>FONABOSQUE (Bs.)</th>
                        <th>SOLICITANTE (Bs.)</th>
                        <th>TOTAL (Bs.)</th>
                        <th>%FONABOSQUE %</th>
                        <th>%SOLICITANTE %</th>
                        <th>%TOTAL</th>
                    </tr>
                </thead>
                <tbody id="product-rows">
                    <tr>
                        <td><input type="number" id="ejecFonaBs" name="ejecFonaBs" value="0.00" step="0.01" class="form-control form-control-sm font-weight-bold border border-info"></td>
                        <td><input type="number" id="ejecSolicBs" name="ejecSolicBs" value="0.00" step="0.01" class="form-control form-control-sm font-weight-bold border border-info"></td>
                        <td id="ejecTotalBs" name="ejecTotalBs">0</td>
                        <input type="hidden" id="ejecTotalBsHidden" name="ejecTotalBs" value="0">                
                        <td id="ejecFonaPor" name="ejecFonaPor">0%</td>
                        <input type="hidden" id="ejecFonaPorHidden" name="ejecFonaPor" value="0">                
                        <td id="ejecSolicPor" name="ejecSolicPor">0%</td>
                        <input type="hidden" id="ejecSolicPorHidden" name="ejecSolicPor" value="0">                
                        <td id="ejecTotalPor" name="ejecTotalPor">0%</td>
                        <input type="hidden" id="ejecTotalPorHidden" name="ejecTotalPor" value="0">     
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="row text-center row mt-2">
            <div class="col">
                <button class="btn btn-success" type="submit">
                    <i class="fas fa-save"></i>GUARDAR</button>
            </div>
            <div class="col">
                <a href="{{ accion2_url }}" class="btn btn-danger">
                    <i class="fas fa-trash-alt"></i>{{ accion2 }}</a>
            </div>
        </div>
    </form>
{% endblock contenido %}

{% block funcScript %}
<script>
$(document).ready(function() {
    // Variables que obtienen el valor de las variables del backend de Django
    var tipo_fin = parseInt("{{ proyecto.tipo_financiamiento }}");  // Correcto: Usamos parseInt para asegurar que sea un número
    var elaboracionEdtpF = parseFloat("{{ proyecto.convocatoria.montoElabEDTP }}");
    var ejecucionEdtp = parseFloat("{{ proyecto.convocatoria.montoEjecEDTP }}");

    // Función de cálculo
    function calcular() {
        // Cálculos para el caso de tipo_fin == 1
        if (tipo_fin == 1) {
            var elabSolicBs = parseFloat($('#elabSolicBs').val()) || 0;
            var elaboracionEdtpS = (elaboracionEdtpF * 100 / 70 - elaboracionEdtpF).toFixed(2);
            var totalelab = ((100 * elaboracionEdtpF) / 70).toFixed(2);

            if (elabSolicBs > elaboracionEdtpS) {
                $('#mensajeelabSolicBs').text("El valor máximo que se otorga por parte del FONABOSQUE es de monto Bs. " + elaboracionEdtpF);
                $('#elabSolicBs').val('0.00');
                elabSolicBs = 0;
            } else {
                $('#mensajeelabSolicBs').text("");
            }

            var elabFonaBs = (elabSolicBs * 70 / 30).toFixed(2);
            var elabTotalBs = (parseFloat(elabSolicBs) + parseFloat(elabFonaBs)).toFixed(2);
            var elabFonaPor = (elabTotalBs === 0 || isNaN(parseFloat(elabFonaBs)) || isNaN(parseFloat(elabTotalBs))) ? "-" : ((parseFloat(elabFonaBs) * 100 / parseFloat(elabTotalBs)).toFixed(2));
            var elabSolicPor = (elabTotalBs === 0 || isNaN(parseFloat(elabSolicBs)) || isNaN(parseFloat(elabTotalBs))) ? "-" : ((parseFloat(elabSolicBs) * 100 / parseFloat(elabTotalBs)).toFixed(2));
            var elabTotalPor = (parseFloat(elabFonaPor) + parseFloat(elabSolicPor)).toFixed(2);

            $('#elabFonaBs').text(elabFonaBs);
            $('#elabTotalBs').text(elabTotalBs);
            $('#elabFonaPor').text(elabFonaPor + '%');
            $('#elabSolicPor').text(elabSolicPor + '%');
            $('#elabTotalPor').text(elabTotalPor + '%');

            $('#elabFonaBsHidden').val(elabFonaBs);
            $('#elabTotalBsHidden').val(elabTotalBs);
            $('#elabFonaPorHidden').val(elabFonaPor);
            $('#elabSolicPorHidden').val(elabSolicPor);
            $('#elabTotalPorHidden').val(elabTotalPor);
        }

        // Cálculos para ejecución (independiente del tipo de financiamiento)
        var ejecFonaBs = parseFloat($('#ejecFonaBs').val()) || 0;

        if (ejecFonaBs > ejecucionEdtp) {
                $('#mensajeejecFonaBs').text("El valor de la solicitud supera el monto de Bs. " + ejecucionEdtp);
                $('#ejecFonaBs').val('0.00');
                ejecFonaBs = 0;  // Si es mayor, asigna 0
            } else {
                $('#mensajeejecFonaBs').text("");  // Limpiar mensaje si el valor es menor
            }

        var ejecSolicBs = parseFloat($('#ejecSolicBs').val()) || 0;
        var ejecTotalBs = ejecFonaBs + ejecSolicBs;
        var ejecFonaPor = (ejecTotalBs === 0 || isNaN(parseFloat(ejecFonaBs)) || isNaN(parseFloat(ejecTotalBs))) ? "-" : ((parseFloat(ejecFonaBs) * 100 / parseFloat(ejecTotalBs)).toFixed(2));
        var ejecSolicPor = (ejecTotalBs === 0 || isNaN(parseFloat(ejecSolicBs)) || isNaN(parseFloat(ejecTotalBs))) ? "-" : ((parseFloat(ejecSolicBs) * 100 / parseFloat(ejecTotalBs)).toFixed(2));
        var ejecTotalPor = (parseFloat(ejecFonaPor) + parseFloat(ejecSolicPor)).toFixed(2);

        $('#ejecTotalBs').text(ejecTotalBs);
        $('#ejecFonaPor').text(ejecFonaPor + '%');
        $('#ejecSolicPor').text(ejecSolicPor + '%');
        $('#ejecTotalPor').text(ejecTotalPor + '%');

        $('#ejecTotalBsHidden').val(ejecTotalBs);
        $('#ejecFonaPorHidden').val(ejecFonaPor);
        $('#ejecSolicPorHidden').val(ejecSolicPor);
        $('#ejecTotalPorHidden').val(ejecTotalPor);
        console.log(tipo_fin)
        if (tipo_fin == 1) {
                if (ejecFonaPor > 70.00 && ejecSolicPor < 30.00) {
                    $('#mensajeejecFPor').text("El %Fonabosque% supera el 70%");
                    $('#mensajeejecSPor').text("El %Solicitud% es menor al 30%");
                    } else {
                        $('#mensajeejecFPor').text("");
                        $('#mensajeejecSPor').text("");
                    }
            } else {
                if (ejecSolicPor < 10.00) {
                        $('#mensajeejecSPor').text("El %Solicitud% es menor al 10%");
                    } else {
                        $('#mensajeejecSPor').text("");
                    }        
                }
        

        // Revisa si hay errores y deshabilita el botón de guardar si hay errores
        checkErrorMessages();
    }

    // Llamamos a la función calcular cuando haya cambios en los campos
    if (tipo_fin == 1) {
        $('#elabSolicBs, #ejecFonaBs, #ejecSolicBs').on('input', calcular);
    } else {
        $('#ejecFonaBs, #ejecSolicBs').on('input', calcular);
    }

    // Función para verificar los mensajes de error
    function checkErrorMessages() {
        if ($('#mensajeejecSPor').text() !== "" || 
            $('#mensajeejecFPor').text() !== "" || 
            $('#mensajeejecFonaBs').text() !== "" || 
            $('#mensajeelabSolicBs').text() !== "") {
            $('button[type="submit"]').prop('disabled', true);
        } else {
            $('button[type="submit"]').prop('disabled', false);
        }
    }

    // Llamar a la función para verificar los mensajes al cargar la página
    checkErrorMessages();

    // Escuchar cambios en los campos de mensaje de error
    $('#mensajeejecSPor, #mensajeejecFPor, #mensajeejecFonaBs, #mensajeelabSolicBs').on('input', function() {
        checkErrorMessages();
    });
});

</script>

{% endblock funcScript %}