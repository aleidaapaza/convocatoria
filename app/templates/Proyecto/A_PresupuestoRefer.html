{% extends 'base/base.html' %}
{% load static %}
{% block contenido %}
    <h3 class="text-center bg-success rounded-3 text-white"> {{ titulo }} </h3>
        {% if entity_registro %}
            <div class="col-md-3 mt-2">
                <a href="{{ entity_registro }}" class="btn btn-success btn-block">{{ entity_registro_nom }}</a>
            </div>
        {% endif %}
        {% if error_messages %}
            <div class="alert alert-danger">
                <ul>
                    {% for message in error_messages %}
                        <li>{{ message }}</li>
                    {% endfor %}
                </ul>
            </div>
        {% endif %}
        {% include "include/mensaje_confirmacion.html" %}
    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <h5 class="text-center bg-success rounded-3 text-white"> Elaboración Estudio de Diseño Técnico de Preinversión - EDTP </h5>
        <div id="mensajeelabSolicBs" style="color: red;"></div>
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>FONABOSQUE (Bs.)</th>
                        <th>SOLICITANTE (Bs.)</th>
                        <th>TOTAL (Bs.)</th>
                        <th>%FONABOSQUE %</th>
                        <th>%SOLICITANTE %</th>
                        <th>% TOTAL</th>
                    </tr>
                </thead>
                <tbody id="product-rows">
                    <tr>
                        <td id="elabFonaBs">{{objetivo.elab_fona}}</td>
                        <input type="hidden" id="elabFonaBsHidden" name="elabFonaBs">
                        <td><input type="text" id="elabSolicBs" name="elabSolicBs" 
                        value="{{objetivo.elab_sol}}" class="form-control form-control-sm font-weight-bold border border-info"></td>
                        <td id="elabTotalBs" name="elabTotalBs">{{objetivo.elab_total}}</td>
                        <input type="hidden" id="elabTotalBsHidden" name="elabTotalBs" >
                        <td id="elabFonaPor" name="elabFonaPor">{{objetivo.elab_fona_p}} %</td>
                        <input type="hidden" id="elabFonaPorHidden" name="elabFonaPor">
                        <td id="elabSolicPor" name="elabSolicPor">{{objetivo.elab_sol_p}} %</td>
                        <input type="hidden" id="elabSolicPorHidden" name="elabSolicPor">
                        <td id="elabTotalPor" name="elabTotalPor">{{objetivo.elab_total_p}} %</td>
                        <input type="hidden" id="elabTotalPorHidden" name="elabTotalPor">                
                    </tr>
                </tbody>
            </table>
        </div>
        <h5 class="text-center bg-success rounded-3 text-white"> 
        Ejecución Estudio de Diseño Técnico de Preinversión - EDTP </h5>
        <div id="mensajeejecFonaBs" style="color: red;"></div>
        <div id="mensajeejecFPor" style="color: red;"></div>    
        <div id="mensajeejecSPor" style="color: red;"></div>    
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>FONABOSQUE (Bs.)</th>
                        <th>SOLICITANTE (Bs.)</th>
                        <th>TOTAL (Bs.)</th>
                        <th>%FONABOSQUE %</th>
                        <th>%SOLICITANTE %</th>
                        <th>%TOTAL</th>
                    </tr>
                </thead>
                <tbody id="product-rows">
                    <tr>
                        <td><input type="text" id="ejecFonaBs" name="ejecFonaBs" value="{{objetivo.ejec_fona}}" 
                        step="0.01" class="form-control form-control-sm font-weight-bold border border-info"></td>
                        <td><input type="text" id="ejecSolicBs" name="ejecSolicBs" value="{{objetivo.ejec_sol}}" 
                        step="0.01" class="form-control form-control-sm font-weight-bold border border-info"></td>
                        <td id="ejecTotalBs" name="ejecTotalBs">{{objetivo.ejec_total}}</td>
                        <input type="hidden" id="ejecTotalBsHidden" name="ejecTotalBs" value="0">                
                        <td id="ejecFonaPor" name="ejecFonaPor">{{objetivo.ejec_fona_p}} %</td>
                        <input type="hidden" id="ejecFonaPorHidden" name="ejecFonaPor" value="0">                
                        <td id="ejecSolicPor" name="ejecSolicPor">{{objetivo.ejec_sol_p}} %</td>
                        <input type="hidden" id="ejecSolicPorHidden" name="ejecSolicPor" value="0">                
                        <td id="ejecTotalPor" name="ejecTotalPor">{{objetivo.ejec_total_p}} %</td>
                        <input type="hidden" id="ejecTotalPorHidden" name="ejecTotalPor" value="0">                

                    </tr>
                </tbody>
            </table>
        </div>

        <div class="row text-center row mt-2">
            <div class="col">
                <button class="btn btn-success" type="submit">
                    <i class="fas fa-save"></i>GUARDAR</button>
            </div>
            <div class="col">
                <a href="{{ accion2_url }}" class="btn btn-danger">
                    <i class="fas fa-trash-alt"></i>{{ accion2 }}</a>
            </div>
        </div>
    </form>
{% endblock contenido %}

{% block funcScript %}
<script>
    document.querySelector('form').addEventListener('submit', function(event) {
        let elabSolicBs = document.getElementById('elabSolicBs');
        // Reemplazar coma por punto
        elabSolicBs.value = elabSolicBs.value.replace(',', '.');
        // Convertir a float para enviar un número válido
        elabSolicBs.value = parseFloat(elabSolicBs.value).toFixed(2);
    });

    $(document).ready(function() {
        function calcular() {
            var elabSolicBs = parseFloat($('#elabSolicBs').val()) || 0;
            if (elabSolicBs > 21000.00) {
                $('#mensajeelabSolicBs').text("El valor de la solicitud supera los 21,000 Bs.");
                $('#elabSolicBs').val('0.00'); 
                elabSolicBs = 0;  // Si es mayor, asigna 0
            } else {
                $('#mensajeelabSolicBs').text("");  // Limpiar mensaje si el valor es menor
            }
            var elabFonaBs = (elabSolicBs * 70 / 30);
            elabFonaBs = (elabFonaBs === 0) ? "-" : elabFonaBs.toFixed(2);
            var elabTotalBs = (elabSolicBs + (elabFonaBs !== "-" ? parseFloat(elabFonaBs) : 0)).toFixed(2);
            var elabFonaPor = (elabTotalBs === 0 || isNaN(parseFloat(elabFonaBs)) || isNaN(elabTotalBs)) ? "-" : ((parseFloat(elabFonaBs) * 100 / parseFloat(elabTotalBs)).toFixed(2));
            var elabSolicPor = (elabTotalBs === 0 || isNaN(parseFloat(elabSolicBs)) || isNaN(elabTotalBs)) ? "-" : ((parseFloat(elabSolicBs) * 100 / parseFloat(elabTotalBs)).toFixed(2));
            var elabTotalPor = (parseFloat(elabFonaPor) + parseFloat(elabSolicPor)).toFixed(2);
            var ejecFonaBs = parseFloat($('#ejecFonaBs').val()) || 0;
            if (ejecFonaBs > 1000000.00) {
                $('#mensajeejecFonaBs').text("El valor de la solicitud supera los 1,000,000 Bs.");
                $('#ejecFonaBs').val('0.00'); 
                ejecFonaBs = 0;  // Si es mayor, asigna 0
            } else {
                $('#mensajeejecFonaBs').text("");  // Limpiar mensaje si el valor es menor
            }
            var ejecSolicBs = parseFloat($('#ejecSolicBs').val()) || 0;
            var ejecTotalBs = ejecFonaBs + ejecSolicBs
            var ejecFonaPor = (ejecTotalBs === 0 || isNaN(parseFloat(ejecFonaBs)) || isNaN(ejecTotalBs)) ? "-" : ((parseFloat(ejecFonaBs) * 100 / parseFloat(ejecTotalBs)).toFixed(2));
            var ejecSolicPor = (ejecTotalBs === 0 || isNaN(parseFloat(ejecSolicBs)) || isNaN(ejecTotalBs)) ? "-" : ((parseFloat(ejecSolicBs) * 100 / parseFloat(ejecTotalBs)).toFixed(2));
            var ejecTotalPor = (parseFloat(ejecFonaPor) + parseFloat(ejecSolicPor)).toFixed(2);
            $('#elabFonaBs').text(elabFonaBs);
            $('#elabTotalBs').text(elabTotalBs);
            $('#elabFonaPor').text(elabFonaPor + '%');
            $('#elabSolicPor').text(elabSolicPor + '%');
            $('#elabTotalPor').text(elabTotalPor + '%');
            $('#ejecTotalBs').text(ejecTotalBs);
            $('#ejecFonaPor').text(ejecFonaPor + '%');
            $('#ejecSolicPor').text(ejecSolicPor + '%');
            $('#ejecTotalPor').text(ejecTotalPor + '%');
            if (ejecFonaPor > 70.00 || ejecSolicPor < 30.00) {
                $('#mensajeejecFPor').text("El %Fonabosque% supera el 70%");
                $('#mensajeejecSPor').text("El %Solicitud% es menor al 30%");
            } else {
                $('#mensajeejecFPor').text("");
                $('#mensajeejecSPor').text("");
            }
            $('#elabFonaBsHidden').val(elabFonaBs);
            $('#elabTotalBsHidden').val(elabTotalBs);
            $('#elabFonaPorHidden').val(elabFonaPor);
            $('#elabSolicPorHidden').val(elabSolicPor);
            $('#elabTotalPorHidden').val(elabTotalPor);
            $('#ejecTotalBsHidden').val(ejecTotalBs);
            $('#ejecFonaPorHidden').val(ejecFonaPor);
            $('#ejecSolicPorHidden').val(ejecSolicPor);
            $('#ejecTotalPorHidden').val(ejecTotalPor);
        }
        // Ejecutar la función calcular cuando haya cambios en los campos
        $('#elabSolicBs, #ejecFonaBs, #ejecSolicBs').on('input', calcular);
    });
</script>
{% endblock funcScript %}